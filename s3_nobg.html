<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Golden Realm - Definitive Grid Planner</title>
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root {
            --bg-color: #2c2f33; --panel-bg: #23272a; --text-color: #e2e2e2;
            --border-color: #4f545c; --accent-color: #7289da; --accent-hover: #5f73bc;
            --active-glow: rgba(114, 137, 218, 0.8);
            --grid-size: 13;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; gap: 20px; height: 100vh; overflow: hidden; }
        .container { display: flex; gap: 20px; width: 100%; height: calc(100vh - 40px); max-width: 1800px; position: relative; }
        .panzoom-wrapper { flex-grow: 1; overflow: hidden; border: 2px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.4); cursor: grab; background-color: #1e2124; transition: width 0.4s ease; }
        .panzoom-wrapper:active { cursor: grabbing; }
        #map-container { width: 900px; height: 900px; background-image: url('S3_map.png'); background-size: 100% 100%; background-position: center; }

        #map-grid { position: relative; width: 100%; height: 100%; }

        .grid-cell { position: absolute; display: flex; justify-content: center; align-items: center; cursor: pointer; box-sizing: border-box; transition: background-color 0.2s ease; }
        .grid-cell:hover .grid-cell-overlay { background-color: rgba(255, 255, 255, 0.25); }
        .grid-cell-overlay { width: 100%; height: 100%; opacity: 0.6; }

        .big-territory { z-index: 1; }
        .small-territory { z-index: 3; border: 1px solid rgba(255, 255, 255, 0.2); background-color: var(--bg-color); }

        /* New styles for on-tile labels */
        .tile-label {
            position: absolute;
            font-size: 8px; /* Small font size to fit */
            font-weight: bold;
            color: white;
            text-shadow: 0 0 3px black, 0 0 3px black; /* Makes text readable on any color */
            pointer-events: none; /* Allows clicks to pass through to the cell */
            z-index: 4;
            text-align: center;
            line-height: 1;
        }
        .small-territory .tile-label { font-size: 7px; }

        .grid-line-container { position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        .grid-line { position: absolute; background-color: rgba(255, 255, 255, 0.2); }
        
        .tooltip { visibility: hidden; background-color: #1a1a1a; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 100; bottom: 110%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; white-space: nowrap; font-size: 14px; border: 1px solid var(--border-color); pointer-events: none; }
        .grid-cell:hover .tooltip { visibility: visible; opacity: 1; }
        .tooltip strong { color: var(--accent-color); }
        
        #control-panel { width: 400px; min-width: 350px; background-color: var(--panel-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 20px; height: 100%; overflow-y: auto; transition: min-width 0.4s ease, width 0.4s ease, padding 0.4s ease, opacity 0.3s ease 0.1s; }
        .container.sidebar-collapsed #control-panel { width: 0; min-width: 0; padding-left: 0; padding-right: 0; opacity: 0; overflow: hidden; }
        
        /* New styles for sidebar toggle button */
        #sidebar-toggle-btn {
            position: absolute; top: 15px; right: 430px; /* 400px panel + 20px gap + 10px buffer */
            width: 30px; height: 30px; background-color: var(--accent-color);
            color: white; border: none; border-radius: 5px 0 0 5px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-size: 1.5em;
            z-index: 1000; transition: right 0.4s ease, background-color 0.2s ease, transform 0.4s ease;
        }
        #sidebar-toggle-btn:hover { background-color: var(--accent-hover); }
        .container.sidebar-collapsed #sidebar-toggle-btn { right: 10px; transform: scaleX(-1); }

        h1,h2,h3 { margin: 0; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); color: var(--accent-color); text-align: center; }
        .control-section { background-color: #2c2f33; padding: 15px; border-radius: 6px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        label { font-weight: 500; }
        input[type="text"], input[type="color"] { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: #36393f; color: var(--text-color); font-size: 1em; }
        input[type="color"] { padding: 4px; height: 40px; }
        .button { padding: 10px 15px; border: none; border-radius: 4px; background-color: var(--accent-color); color: white; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s; width: 100%; font-size: 1em; }
        .button:hover { background-color: var(--accent-hover); }
        .button.secondary { background-color: #4f545c; }
        .button.secondary:hover { background-color: #6a707a; }
        #alliance-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; }
        .alliance-item { background-color: #36393f; border-radius: 6px; padding: 15px; border-left: 5px solid; display: flex; flex-direction: column; gap: 10px; cursor: pointer; transition: box-shadow 0.3s, border-width 0.3s; }
        .alliance-item.active { box-shadow: 0 0 10px 2px var(--active-glow); border-left-width: 8px; }
        .alliance-header { display: flex; justify-content: space-between; align-items: center; }
        .alliance-name { font-weight: bold; font-size: 1.1em; }
        .alliance-buffs { border-top: 1px solid var(--border-color); padding-top: 10px; font-size: 0.9em; }
        .buff-summary-list { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .buff-summary-list li { background-color: #2c2f33; padding: 5px; border-radius: 3px; }
        .buff-summary-list .buff-type { font-weight: 500; }
        .buff-summary-list .buff-value { font-weight: bold; color: #63d471; float: right; }
        #data-management-buttons { display: flex; gap: 10px; }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <!-- New sidebar toggle button -->
        <button id="sidebar-toggle-btn" title="Toggle Sidebar">Â»</button>
        
        <div class="panzoom-wrapper">
            <div id="map-container">
                <div id="map-grid"></div>
            </div>
        </div>
        <aside id="control-panel">
            <h1>Definitive Planner</h1>
            <div class="control-section"><h3>Alliance Management</h3><div id="add-alliance-form"><div class="form-group"><label for="alliance-name-input">Alliance Name:</label><input type="text" id="alliance-name-input" placeholder="e.g., The Winners"></div><div class="form-group"><label for="alliance-color-input">Alliance Color:</label><input type="color" id="alliance-color-input" value="#ff3e3e"></div><button id="add-alliance-btn" class="button">Add Alliance</button></div></div>
            <div class="control-section"><h2>Alliances & Buffs</h2><p id="alliance-selection-info">Click an alliance below to make it active, then click on the map to assign/unassign tiles.</p><ul id="alliance-list"></ul></div>
            <div class="control-section"><h3>Data Management</h3><div id="data-management-buttons"><button id="export-btn" class="button secondary">Export to File</button><button id="import-btn" class="button secondary">Import from File</button><input type="file" id="import-file-input" accept=".json" style="display: none;"></div></div>
        </aside>
    </div>

    <script>
    // --- DATA ---
    const providedData = {
      "0": { "id": 0, "name": "Stronghold Lvl 1 / 1% Iron", "tiles": [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 25, 38, 51, 64, 77, 90, 103, 116, 129, 142, 155, 168, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 143, 130, 117, 104, 91, 78, 65, 52, 39, 26, 13 ] },
      "1": { "id": 1, "name": "Stronghold Lvl 2 / 2% Iron", "tiles": [ 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 37, 50, 63, 76, 89, 102, 115, 128, 141, 154, 153, 152, 151, 150, 149, 148, 147, 146, 145, 144, 131, 118, 105, 92, 79, 66, 40, 27, 53 ] },
      "2": { "id": 2, "name": "Stronghold Lvl 3 / 3% Iron", "tiles": [ 36, 35, 34, 33, 32, 31, 30, 29, 28, 41, 54, 67, 80, 93, 106, 119, 132, 133, 134, 135, 136, 137, 138, 139, 140, 127, 114, 101, 88, 62, 49, 75 ] },
      "3": { "id": 3, "name": "Stronghold Lvl 4 / 4% Iron", "tiles": [ 42, 43, 44, 45, 46, 47, 48, 61, 74, 87, 100, 113, 126, 125, 124, 123, 122, 121, 120, 107, 94, 81, 68, 55 ] },
      "4": { "id": 4, "name": "Stronghold Lvl 5 / 5% Iron", "tiles": [ 56, 57, 58, 59, 60, 73, 86, 99, 112, 111, 110, 109, 108, 95, 82, 69 ] },
      "5": { "id": 5, "name": "Stronghold Lvl 6 / 6% Iron", "tiles": [ 70, 71, 72, 85, 98, 97, 96, 83 ] },
      "6": { "id": 6, "name": "Great Pyramid / 10% Marching Speed", "tiles": [ 84 ] },
      "7": { "id": 7, "name": "Trading Post Lvl 1", "tiles": [ 169, 180, 312, 301 ] },
      "8": { "id": 8, "name": "Trading Post Lvl 2", "tiles": [ 299, 290, 182, 191 ] },
      "9": { "id": 9, "name": "Trading Post Lvl 3", "tiles": [ 195, 279, 286, 202 ] },
      "10": { "id": 10, "name": "Trading Post Lvl 4", "tiles": [ 273, 268, 213, 208 ] },
      "11": { "id": 11, "name": "Trading Post Lvl 5", "tiles": [ 224, 221, 260, 257 ] },
      "12": { "id": 12, "name": "Square of Judgment / 20% Construction", "tiles": [ 234 ] },
      "13": { "id": 13, "name": "Square of Judgment / 20% Research", "tiles": [ 246 ] },
      "14": { "id": 14, "name": "Square of Judgment / 10% Healing", "tiles": [ 235 ] },
      "15": { "id": 15, "name": "Square of Judgment / 5% Training", "tiles": [ 247 ] },
      "16": { "id": 16, "name": "Village Lvl 1 / 7,5% Food", "tiles": [ 170, 172, 174, 175, 177, 179, 204, 228, 252, 276, 300, 310, 308, 305, 303, 193, 217, 241, 265, 289 ] },
      "17": { "id": 17, "name": "Village Lvl 1 / 7,5% Iron", "tiles": [ 307, 306, 309, 311, 288, 264, 240, 216, 304, 302, 277, 253, 229, 205, 181, 171, 173, 176, 178, 192 ] },
      "18": { "id": 18, "name": "Altar Lvl 2 / 7,5% Gathering Speed", "tiles": [ 194, 218, 242, 266, 292, 294, 296, 298, 275, 251, 227, 203, 190, 188, 186, 184 ] },
      "19": { "id": 19, "name": "Altar Lvl 2 / 7,5% Coin", "tiles": [ 189, 187, 185, 183, 206, 230, 254, 278, 215, 239, 263, 287, 297, 295, 293, 291 ] },
      "20": { "id": 20, "name": "Town Lvl 3 / 15% Food", "tiles": [ 196, 198, 200, 226, 250, 274, 284, 281, 267, 243, 219 ] },
      "21": { "id": 21, "name": "Town Lvl 3 / 15% Iron", "tiles": [ 197, 199, 201, 214, 238, 262, 285, 283, 282, 280, 255, 231, 207 ] },
      "22": { "id": 22, "name": "Temple of the Sun Lvl 4 / 15% Coin", "tiles": [ 209, 211, 237, 261, 271, 269, 256, 232 ] },
      "23": { "id": 23, "name": "Temple of the Sun Lvl 4 / 15% Gathering Speed", "tiles": [ 210, 212, 225, 249, 272, 270, 244, 220 ] },
      "24": { "id": 24, "name": "Ancient Tombs Lvl 5 / 25% Food", "tiles": [ 222, 223, 248, 245 ] },
      "25": { "id": 25, "name": "Ancient Tombs Lvl 5 / 25% Iron", "tiles": [ 259, 258, 233, 236 ] }
    };

    function buildTileDataMap(data) { const map = {}; for (const id in data) { const alliance = data[id]; for (const tileId of alliance.tiles) { map[tileId] = alliance.name; } } return map; }
    const tileDataMap = buildTileDataMap(providedData);

    function parseTileInfo(dataString) { if (!dataString) dataString = "Land / None"; const parts = dataString.split(' / '); const infoPart = parts[0]; let type = infoPart.trim(); let level = 0; const levelMatch = infoPart.match(/(.+) Lvl (\d+)/); if (levelMatch) { type = levelMatch[1].trim(); level = parseInt(levelMatch[2], 10); } return { type, level, buff: dataString }; }
    
    function parseBuff(buffString) { if (!buffString) return { type: 'None', value: 0 }; const parts = buffString.split(' / '); if (parts.length < 2) return { type: 'None', value: 0 }; const buffPart = parts[1]; const match = buffPart.match(/([\d.,]+)%\s*(.*)/); if (!match) return { type: 'None', value: 0 }; try { const value = parseFloat(match[1].replace(',', '.')); const type = match[2].trim(); if (isNaN(value) || !type) return { type: 'None', value: 0 }; return { type, value }; } catch(e) { return { type: 'None', value: 0 }; } }

    function createMapData() {
        const data = []; let tileIdCounter = 0;
        for (let y = 0; y < 13; y++) { for (let x = 0; x < 13; x++) { const dataString = tileDataMap[tileIdCounter] || 'Land / None 0%'; const tileInfo = parseTileInfo(dataString); data.push({ id: tileIdCounter++, kind: 'big', x, y, type: tileInfo.type, level: tileInfo.level, buff: tileInfo.buff }); } }
        for (let y = 0; y < 12; y++) { for (let x = 0; x < 12; x++) { const dataString = tileDataMap[tileIdCounter] || 'Node / None 0%'; const tileInfo = parseTileInfo(dataString); data.push({ id: tileIdCounter++, kind: 'small', x, y, type: tileInfo.type, level: tileInfo.level, buff: tileInfo.buff }); } }
        return data;
    }
    const mapData = createMapData();

    // Helper & State
    let alliances={};let activeAllianceId=null;let nextAllianceId=0;
    const vibrantColors=["#E6194B","#3CB44B","#FFE119","#4363D8","#F58231","#911EB4","#46F0F0","#F032E6","#BCF60C","#FABEBE","#008080","#E6BEFF","#9A6324","#FFFAC8","#800000","#AAFFC3"];
    const dom={mainContainer:document.getElementById("main-container"), mapGrid:document.getElementById("map-grid"),allianceList:document.getElementById("alliance-list"),addAllianceBtn:document.getElementById("add-alliance-btn"),allianceNameInput:document.getElementById("alliance-name-input"),allianceColorInput:document.getElementById("alliance-color-input"),exportBtn:document.getElementById("export-btn"),importBtn:document.getElementById("import-btn"),importFileInput:document.getElementById("import-file-input"),mapContainer:document.getElementById("map-container"), sidebarToggleBtn:document.getElementById('sidebar-toggle-btn')};
    
    function generateMap() {
        dom.mapGrid.innerHTML = '';
        const GRID_SIZE = 13;
        const gridLineContainer = document.createElement('div');
        gridLineContainer.className = 'grid-line-container';

        for (let i = 1; i < GRID_SIZE; i++) {
            const hLine = document.createElement('div'); hLine.className = 'grid-line'; hLine.style.width = '100%'; hLine.style.height = '1px'; hLine.style.top = `calc(${i} / ${GRID_SIZE} * 100% - 0.5px)`; gridLineContainer.appendChild(hLine);
            const vLine = document.createElement('div'); vLine.className = 'grid-line'; vLine.style.height = '100%'; vLine.style.width = '1px'; vLine.style.left = `calc(${i} / ${GRID_SIZE} * 100% - 0.5px)`; gridLineContainer.appendChild(vLine);
        }
        dom.mapGrid.appendChild(gridLineContainer);
        
        mapData.forEach(tile => {
            const cell = document.createElement('div');
            cell.className = `grid-cell ${tile.kind}-territory`; cell.dataset.tileId = tile.id;
            
            const size = 100 / GRID_SIZE;
            if (tile.kind === 'big') { cell.style.width = `${size}%`; cell.style.height = `${size}%`; cell.style.left = `${tile.x * size}%`; cell.style.top = `${tile.y * size}%`; }
            else { const smallSize = size * 0.5; cell.style.width = `${smallSize}%`; cell.style.height = `${smallSize}%`; cell.style.left = `${(tile.x + 1) * size}%`; cell.style.top = `${(tile.y + 1) * size}%`; cell.style.transform = 'translate(-50%, -50%)'; }
            
            cell.addEventListener('click', () => handleCellClick(tile.id));
            cell.appendChild(createOverlay());
            cell.appendChild(createTooltip(tile));
            cell.appendChild(createTileLabel(tile)); // Add the on-tile label
            dom.mapGrid.appendChild(cell);
        });
    }
    
    function createOverlay() { const o = document.createElement('div'); o.className = 'grid-cell-overlay'; return o; }
    
    function createTileLabel(tile) {
        const label = document.createElement('div');
        label.className = 'tile-label';
        const parsed = parseBuff(tile.buff);
        if (parsed.type !== 'None' && parsed.value > 0) {
            label.textContent = `+${parsed.value.toLocaleString()}%`;
        }
        return label;
    }

    function createTooltip(tile) {
        const t = document.createElement('div'); t.className = 'tooltip';
        let title = tile.level > 0 ? `${tile.type} (Lvl ${tile.level})` : tile.type;
        const parsed = parseBuff(tile.buff);
        let buffText = 'No Buff';
        if (parsed.type !== 'None') { buffText = `+${parsed.value.toLocaleString()}% ${parsed.type}`; }
        t.innerHTML = `<strong>${title}</strong><br>${buffText}`;
        return t;
    }
    
    function renderMap() {
        const tileOwners = {};
        for (const id in alliances) { alliances[id].tiles.forEach(tileId => { tileOwners[tileId] = alliances[id].color; }); }
        dom.mapGrid.querySelectorAll('.grid-cell').forEach(cell => { const tileId = cell.dataset.tileId; const overlay = cell.querySelector('.grid-cell-overlay'); if (overlay) { overlay.style.backgroundColor = tileOwners[tileId] || 'transparent'; } });
    }
    
    function handleCellClick(territoryId) { if (activeAllianceId === null) { alert('Please select an active alliance from the list on the right first!'); return; } const tileIsOwned = alliances[activeAllianceId].tiles.includes(Number(territoryId)); for (const id in alliances) { alliances[id].tiles = alliances[id].tiles.filter(tId => tId !== Number(territoryId)); } if (!tileIsOwned) { alliances[activeAllianceId].tiles.push(Number(territoryId)); } updateAllBuffs(); renderMap(); }
    function addAlliance() { const name = dom.allianceNameInput.value.trim(); if (!name) return; const id = nextAllianceId++; alliances[id] = { id: id, name: name, color: dom.allianceColorInput.value, tiles: [] }; dom.allianceNameInput.value = ''; dom.allianceColorInput.value = vibrantColors[nextAllianceId % vibrantColors.length]; setActiveAlliance(id); }
    function setActiveAlliance(id) { activeAllianceId = id; renderAlliances(); }
    function calculateBuffsForAlliance(alliance) { const totalBuffs = {}; alliance.tiles.forEach(tileId => { const tileData = mapData.find(t => t.id == tileId); if (tileData && tileData.buff) { const parsed = parseBuff(tileData.buff); if (parsed.type !== 'None') { totalBuffs[parsed.type] = (totalBuffs[parsed.type] || 0) + parsed.value; } } }); return totalBuffs; }
    function updateAllBuffs() { for (const id in alliances) { const alliance = alliances[id]; const buffs = calculateBuffsForAlliance(alliance); const buffListElem = document.querySelector(`.alliance-item[data-id='${id}'] .buff-summary-list`); if(buffListElem) { let html = ''; const sortedBuffs = Object.keys(buffs).sort(); html = sortedBuffs.length === 0 ? '<li>No buffs yet.</li>' : sortedBuffs.map(type => `<li><span class="buff-type">${type}:</span> <span class="buff-value">+${buffs[type].toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}%</span></li>`).join(''); buffListElem.innerHTML = html; } } }
    function renderAlliances() { dom.allianceList.innerHTML = ''; Object.values(alliances).forEach(alliance => { const item = document.createElement('li'); item.className = 'alliance-item'; item.dataset.id = alliance.id; item.style.borderColor = alliance.color; if (alliance.id === activeAllianceId) item.classList.add('active'); item.innerHTML = `<div class="alliance-header"><span class="alliance-name">${alliance.name}</span></div><div class="alliance-buffs"><strong>Buff Summary:</strong><ul class="buff-summary-list"></ul></div>`; item.addEventListener('click', () => setActiveAlliance(alliance.id)); dom.allianceList.appendChild(item); }); updateAllBuffs(); }
    function exportState() { if (Object.keys(alliances).length === 0) { alert("Nothing to export."); return; } const stateString = JSON.stringify(alliances, null, 2); const blob = new Blob([stateString], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `golden-realm-plan-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    function importState(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = e => { try { const data = JSON.parse(e.target.result); if (typeof data !== 'object' || data === null || Array.isArray(data)) throw new Error("Invalid format."); alliances = {}; Object.values(data).forEach(ally => { alliances[ally.id] = {...ally, tiles: ally.tiles.map(Number)}; }); nextAllianceId = Math.max(-1, ...Object.keys(alliances).map(Number)) + 1; activeAllianceId = null; renderAlliances(); renderMap(); alert('Plan loaded!'); } catch (err) { alert('Failed to load file.\n' + err.message); } }; reader.readAsText(file); event.target.value = ''; }
    
    // New function to toggle the sidebar
    function toggleSidebar() {
        dom.mainContainer.classList.toggle('sidebar-collapsed');
    }
    
    function init() { 
        generateMap(); 
        dom.allianceColorInput.value = vibrantColors[0]; 
        // Changed minScale from 0.8 to 0.3 for more zoom-out capability
        const panzoom = Panzoom(dom.mapContainer, { maxScale: 30, minScale: 0.3, contain: 'outside', canvas: true }); 
        dom.mapContainer.parentElement.addEventListener('wheel', panzoom.zoomWithWheel); 
        dom.addAllianceBtn.addEventListener('click', addAlliance); 
        dom.exportBtn.addEventListener('click', exportState); 
        dom.importBtn.addEventListener('click', () => dom.importFileInput.click()); 
        dom.importFileInput.addEventListener('change', importState); 
        // Add event listener for the new toggle button
        dom.sidebarToggleBtn.addEventListener('click', toggleSidebar);
    }
    init();
    </script>
</body>
</html>